# DECISIONS

## 2025-11-16 - Security Architecture Decisions

### Common Security Modules Pattern
- **Decision:** Create shared `common/` directory for reusable security modules
- **Location:** `/NOVEMBER/PGP_v1/common/`
- **Rationale:**
  - DRY principle: Write once, use across all 15 services
  - Consistency: Same security logic everywhere
  - Maintainability: Single point for security updates
  - Testing: Easier to test security modules in isolation
- **Modules Created:**
  - `oidc_auth.py` - Service-to-service authentication
  - `security_headers.py` - HTTP security headers (3 profiles)
  - `validators.py` - Input validation (payments, wallets, orders, IPN)
  - `__init__.py` - Package exports

### OIDC vs API Key Authentication
- **Decision:** Use OIDC tokens for service-to-service authentication (not API keys)
- **Rationale:**
  - OIDC tokens auto-generated by Cloud Run/Cloud Tasks
  - No secrets to manage (Google handles key rotation)
  - Built-in expiration (short-lived tokens)
  - Service account identity verification
  - Industry best practice for microservices
- **Implementation:** `@require_oidc_token` decorator on internal endpoints
- **Alternative Rejected:** Custom API keys (requires manual rotation, storage in Secret Manager)

### HTTP Security Headers via Flask-Talisman
- **Decision:** Use Flask-Talisman library for security headers (not manual headers)
- **Rationale:**
  - Battle-tested library used by Google/industry
  - Automatic CSP, HSTS, X-Frame-Options, etc.
  - Three profiles for different service types
  - Prevents common mistakes (incorrect header values)
- **Profiles Created:**
  - **INTERNAL:** Most restrictive (no content allowed) - for Cloud Run-to-Cloud Run services
  - **API:** JSON-only (no scripts/styles) - for REST APIs
  - **WEB:** Safe content (React-compatible) - for frontend

### Content Security Policy (CSP) Strategy
- **Decision:** Different CSP configurations per service type (not one-size-fits-all)
- **Rationale:**
  - Internal services don't render content â†’ block everything (`default-src 'none'`)
  - APIs only return JSON â†’ no JavaScript needed (`script-src 'none'`)
  - Web frontend needs React â†’ allow self + CDNs (`script-src 'self' 'unsafe-inline'`)
- **Trade-off:** More complex but more secure (principle of least privilege)

### Input Validation Layering
- **Decision:** Multi-layer validation (format â†’ business logic â†’ database)
- **Implementation:**
  1. **Format Validation:** Regex patterns for wallet addresses, order IDs
  2. **Business Logic Validation:** Amount limits, decimal precision, currency support
  3. **Database Validation:** Foreign key constraints, NOT NULL
- **Rationale:** Defense-in-depth (multiple layers catch different issues)

### Log Data Sanitization
- **Decision:** Mask sensitive data in logs (not full payment amounts/wallets)
- **Pattern:**
  - Payment amounts: `***50.00` (mask high-value digits)
  - Wallet addresses: `0x1234...abcd` (first 6 + last 4 characters)
- **Rationale:**
  - Privacy: Prevents full data exposure in logs
  - Compliance: GDPR/PCI DSS data minimization
  - Debugging: Still shows enough info to identify transactions
- **Alternative Rejected:** Full logging (compliance risk), no logging (debugging impossible)

### Bulk Update Script vs Manual Updates
- **Decision:** Use Python script for bulk updates (not manual file editing)
- **Script:** `bulk_security_update.py`
- **Rationale:**
  - Consistency: Same changes across 8 services
  - Speed: 8 services updated in 2 minutes vs 30+ minutes manual
  - Accuracy: Regex patterns ensure correct placement
  - Idempotency: Script detects existing changes, skips them
- **Manual Updates:** Used for first 3 services to validate approach, then automated rest

### OIDC Token Audience Verification
- **Decision:** Verify token audience matches service URL (not skip audience check)
- **Implementation:** `audience = os.environ.get('SERVICE_URL', request.url_root)`
- **Rationale:**
  - Prevents token replay to different services
  - Audience claim ensures token intended for THIS service
  - Standard OIDC security practice
- **Fallback:** Use request URL if SERVICE_URL not set (Cloud Run provides this)

### Replay Attack Prevention
- **Decision:** Defer to future phase (not implemented now)
- **Rationale:**
  - HMAC signature + OIDC already provide strong auth
  - Replay attacks require timestamp validation + nonce tracking
  - Adds complexity (Redis/Memcached for nonce storage)
  - Not critical for MVP (attacks would need to compromise OIDC tokens)
- **Future:** Implement if threat model requires (e.g., high-value transactions)

### Rate Limiting Strategy
- **Decision:** Use existing Flask-Limiter (API service) + defer app-level rate limiting
- **Current State:**
  - pgp-server-v1 (API) has Flask-Limiter configured
  - Internal services rely on Cloud Run default limits (1000 concurrent)
- **Future:** Add Flask-Limiter to pgp-npwebhook-v1 if needed
- **Rationale:**
  - Cloud Run limits sufficient for internal services
  - External-facing services (API, webhook) are priority
  - Can add incrementally based on monitoring

### Database IAM Authentication
- **Decision:** Defer to future phase (continue using password auth for now)
- **Rationale:**
  - IAM auth requires code changes (enable_iam_auth=True)
  - Requires database user setup (service account emails)
  - Password auth works and is encrypted via TLS
  - Not blocking for deployment
- **Future:** Migrate to IAM auth for better security (no password rotation needed)

### Deployment Order for Security Updates
- **Decision:** Deploy all services together (not incremental)
- **Rationale:**
  - OIDC tokens required by callers AND callees
  - Incremental deployment would break service-to-service calls
  - Security headers don't break anything (safe to deploy all)
- **Sequence:**
  1. Deploy all 11 internal services (with OIDC receivers)
  2. Deploy 3 external services (with security headers)
  3. Deploy Telegram bot (with security headers)
  4. Deploy frontend (React app, already HTTPS)

---

## 2025-11-16 - PayGatePrime v1 Migration Architecture

### Individual Service Deployment Scripts
- **Decision:** Create individual deployment scripts for each of 15 services
- **Location:** `deployment_scripts/individual_services/`
- **Rationale:**
  - Granular control for debugging specific services
  - Ability to deploy/redeploy single services without affecting others
  - Easier troubleshooting with service-specific configurations
  - Better documentation with per-service next steps
- **Scripts Created:** 16 total (15 individual + 1 master orchestration)
- **Master Script:** `deploy_all_services.sh` orchestrates deployment in correct order
- **Benefits:**
  - Deploy all at once OR one at a time
  - Each script self-contained with all required secrets
  - Service-specific resource allocation (memory, CPU, timeout)
  - Clear authentication settings (public vs internal)
  - Automatic URL secret updates after each phase

### Project Migration Strategy
- **Decision:** Migrate from `telepay-459221` to new `pgp-live` GCP project
- **Rationale:** Fresh start for PayGatePrime v1 with clean project structure
- **Impact:** All 14 services, 46 secrets, and database instance must be recreated

### Service Naming Convention
- **Decision:** Remove `-10-26` suffix from service names
- **New Pattern:** `GCRegisterAPI-PGP`, `GCWebhook1-PGP`, etc.
- **Rationale:** Date-based naming is confusing; use product-based naming

### Database Instance Naming
- **Decision:** Suggest new instance name `pgp-psql` (vs old `telepaypsql`)
- **Connection Format:** `pgp-live:us-central1:pgp-psql`
- **Database Name:** Consider `pgpdb` (vs old `telepaydb`)

### Secret Management Approach
- **Decision:** All secrets managed via GCP Secret Manager (no .env files)
- **Total Secrets:** 46 secrets documented
- **Priority Tiers:** Critical (ðŸ”´), High (ðŸŸ¡), Medium (ðŸŸ¢)

### Code Migration Methodology
- **Decision:** Systematic 8-phase approach via MIGRATION_CHECKLIST.md
- **Sequence:** Discovery â†’ Copy â†’ Update â†’ Verify â†’ Document
- **No Deployment:** Code preparation only; deployment handled separately

### Documentation Structure
- **Created:** MIGRATION_CHECKLIST.md (master plan)
- **Created:** SECRET_CONFIG_UPDATE.md (46 secrets catalog)
- **Created:** DISCOVERY_REPORT.md (analysis findings)
- **Approach:** Separate concerns for clarity and reference
