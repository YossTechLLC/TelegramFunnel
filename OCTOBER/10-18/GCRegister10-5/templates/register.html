{% extends "base.html" %}

{% block title %}Register Channel{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10 col-xl-8">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h2 class="h4 mb-0">üìù Channel Registration Form</h2>
            </div>
            <div class="card-body p-4">
                <p class="text-muted mb-4">
                    Fill out the form below to register your Telegram channels for the subscription payment system.
                    All fields are required.
                </p>

                <form method="POST" action="{{ url_for('register') }}" novalidate>
                    {{ form.hidden_tag() }}

                    <!-- Open Channel Section -->
                    <div class="section-divider mb-4">
                        <h3 class="h5 text-primary mb-3">üì¢ Open Channel Information</h3>
                        <p class="text-muted small">Your public channel where users can browse subscription options</p>

                        <div class="mb-3">
                            {{ form.open_channel_id.label(class="form-label fw-bold") }}
                            {{ form.open_channel_id(class="form-control" + (" is-invalid" if form.open_channel_id.errors else "")) }}
                            <div class="form-text">Your public channel's Telegram ID (e.g., -1001234567890)</div>
                            {% if form.open_channel_id.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.open_channel_id.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            {{ form.open_channel_title.label(class="form-label fw-bold") }}
                            {{ form.open_channel_title(class="form-control" + (" is-invalid" if form.open_channel_title.errors else "")) }}
                            {% if form.open_channel_title.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.open_channel_title.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            {{ form.open_channel_description.label(class="form-label fw-bold") }}
                            {{ form.open_channel_description(class="form-control" + (" is-invalid" if form.open_channel_description.errors else "")) }}
                            {% if form.open_channel_description.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.open_channel_description.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Closed Channel Section -->
                    <div class="section-divider mb-4">
                        <h3 class="h5 text-primary mb-3">üîí Closed Channel Information</h3>
                        <p class="text-muted small">Your premium channel with exclusive content for subscribers</p>

                        <div class="mb-3">
                            {{ form.closed_channel_id.label(class="form-label fw-bold") }}
                            {{ form.closed_channel_id(class="form-control" + (" is-invalid" if form.closed_channel_id.errors else "")) }}
                            <div class="form-text">Your premium channel's Telegram ID (e.g., -1001234567891)</div>
                            {% if form.closed_channel_id.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.closed_channel_id.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            {{ form.closed_channel_title.label(class="form-label fw-bold") }}
                            {{ form.closed_channel_title(class="form-control" + (" is-invalid" if form.closed_channel_title.errors else "")) }}
                            {% if form.closed_channel_title.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.closed_channel_title.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            {{ form.closed_channel_description.label(class="form-label fw-bold") }}
                            {{ form.closed_channel_description(class="form-control" + (" is-invalid" if form.closed_channel_description.errors else "")) }}
                            {% if form.closed_channel_description.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.closed_channel_description.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Subscription Tiers Section -->
                    <div class="section-divider mb-4">
                        <h3 class="h5 text-primary mb-3">üí∞ Subscription Pricing Tiers</h3>
                        <p class="text-muted small">Configure three subscription tiers (Bronze, Silver, Gold)</p>

                        <!-- Tier 1 -->
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h4 class="h6 mb-0">ü•â Tier 1 - Bronze</h4>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        {{ form.sub_1_price.label(class="form-label fw-bold") }}
                                        {{ form.sub_1_price(class="form-control" + (" is-invalid" if form.sub_1_price.errors else "")) }}
                                        {% if form.sub_1_price.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.sub_1_price.errors %}{{ error }}{% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        {{ form.sub_1_time.label(class="form-label fw-bold") }}
                                        {{ form.sub_1_time(class="form-control" + (" is-invalid" if form.sub_1_time.errors else "")) }}
                                        {% if form.sub_1_time.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.sub_1_time.errors %}{{ error }}{% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tier 2 -->
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h4 class="h6 mb-0">ü•à Tier 2 - Silver</h4>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        {{ form.sub_2_price.label(class="form-label fw-bold") }}
                                        {{ form.sub_2_price(class="form-control" + (" is-invalid" if form.sub_2_price.errors else "")) }}
                                        {% if form.sub_2_price.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.sub_2_price.errors %}{{ error }}{% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        {{ form.sub_2_time.label(class="form-label fw-bold") }}
                                        {{ form.sub_2_time(class="form-control" + (" is-invalid" if form.sub_2_time.errors else "")) }}
                                        {% if form.sub_2_time.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.sub_2_time.errors %}{{ error }}{% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tier 3 -->
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h4 class="h6 mb-0">ü•á Tier 3 - Gold</h4>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        {{ form.sub_3_price.label(class="form-label fw-bold") }}
                                        {{ form.sub_3_price(class="form-control" + (" is-invalid" if form.sub_3_price.errors else "")) }}
                                        {% if form.sub_3_price.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.sub_3_price.errors %}{{ error }}{% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        {{ form.sub_3_time.label(class="form-label fw-bold") }}
                                        {{ form.sub_3_time(class="form-control" + (" is-invalid" if form.sub_3_time.errors else "")) }}
                                        {% if form.sub_3_time.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.sub_3_time.errors %}{{ error }}{% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Information Section -->
                    <div class="section-divider mb-4">
                        <h3 class="h5 text-primary mb-3">üè¶ Payment Information</h3>
                        <p class="text-muted small">Your cryptocurrency wallet details for receiving payouts</p>

                        <div class="mb-3">
                            {{ form.client_payout_network.label(class="form-label fw-bold") }}
                            {{ form.client_payout_network(class="form-select" + (" is-invalid" if form.client_payout_network.errors else "")) }}
                            <div class="form-text">Select the blockchain network for your payouts</div>
                            {% if form.client_payout_network.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.client_payout_network.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            {{ form.client_payout_currency.label(class="form-label fw-bold") }}
                            {{ form.client_payout_currency(class="form-select" + (" is-invalid" if form.client_payout_currency.errors else "")) }}
                            <div class="form-text">The cryptocurrency you want to receive as payment</div>
                            {% if form.client_payout_currency.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.client_payout_currency.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <!-- Reset Button for Payment Fields -->
                        <div class="mb-4 text-center">
                            <button type="button" id="resetPaymentFieldsBtn" class="btn btn-outline-secondary btn-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-counterclockwise me-1" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M8 3a5 5 0 1 1-4.546 2.914.5.5 0 0 0-.908-.417A6 6 0 1 0 8 2v1z"/>
                                    <path d="M8 4.466V.534a.25.25 0 0 0-.41-.192L5.23 2.308a.25.25 0 0 0 0 .384l2.36 1.966A.25.25 0 0 0 8 4.466z"/>
                                </svg>
                                Reset Network & Currency Selection
                            </button>
                        </div>

                        <div class="mb-3">
                            {{ form.client_wallet_address.label(class="form-label fw-bold") }}
                            {{ form.client_wallet_address(class="form-control" + (" is-invalid" if form.client_wallet_address.errors else "")) }}
                            <div class="form-text">Your cryptocurrency wallet address (max 110 characters)</div>
                            {% if form.client_wallet_address.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.client_wallet_address.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- CAPTCHA Section -->
                    <div class="section-divider mb-4">
                        <h3 class="h5 text-primary mb-3">üîê Security Verification</h3>

                        <div class="card bg-light mb-3">
                            <div class="card-body">
                                <p class="mb-2 fw-bold">{{ captcha_question }}</p>
                                {{ form.captcha(class="form-control" + (" is-invalid" if form.captcha.errors else ""), style="max-width: 200px;") }}
                                {% if form.captcha.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.captcha.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="d-grid">
                        {{ form.submit(class="btn btn-primary btn-lg") }}
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Global data storage for currency-network mappings
    let currencyNetworkData = {
        network_to_currencies: {},
        currency_to_networks: {},
        all_networks: [],
        all_currencies: [],
        networks_with_names: {},  // Maps network code -> network_name
        currencies_with_names: {} // Maps currency code -> currency_name
    };

    // Fetch currency-network mappings from API
    async function fetchCurrencyNetworkMappings() {
        try {
            console.log('üîç Fetching currency-network mappings...');
            const response = await fetch('/api/currency-network-mappings');
            const result = await response.json();

            if (result.success && result.data) {
                currencyNetworkData.network_to_currencies = result.data.network_to_currencies;
                currencyNetworkData.currency_to_networks = result.data.currency_to_networks;
                currencyNetworkData.networks_with_names = result.data.networks_with_names;
                currencyNetworkData.currencies_with_names = result.data.currencies_with_names;

                // Extract unique networks and currencies
                currencyNetworkData.all_networks = Object.keys(result.data.network_to_currencies).sort();
                currencyNetworkData.all_currencies = Object.keys(result.data.currency_to_networks).sort();

                console.log(`‚úÖ Loaded ${currencyNetworkData.all_networks.length} networks and ${currencyNetworkData.all_currencies.length} currencies with friendly names`);

                // Populate initial network dropdown
                populateNetworkDropdown();
                populateCurrencyDropdown();
            } else {
                console.error('‚ùå Failed to fetch mappings:', result.error);
            }
        } catch (error) {
            console.error('‚ùå Error fetching currency-network mappings:', error);
        }
    }

    // Populate network dropdown with all available networks
    function populateNetworkDropdown(selectedNetwork = '') {
        const networkSelect = document.getElementById('client_payout_network');
        if (!networkSelect) return;

        // Clear existing options except the first placeholder
        networkSelect.innerHTML = '<option value="">-- Select Network --</option>';

        // Add all networks with formatted display: "CODE - Name"
        currencyNetworkData.all_networks.forEach(network => {
            const option = document.createElement('option');
            option.value = network;  // Value is just the code (e.g., "ETH")

            // Get friendly name from lookup table
            const networkName = currencyNetworkData.networks_with_names[network] || network;
            option.textContent = `${network} - ${networkName}`;  // Display: "ETH - Ethereum"

            if (network === selectedNetwork) {
                option.selected = true;
            }
            networkSelect.appendChild(option);
        });

        console.log(`üìä Populated network dropdown with ${currencyNetworkData.all_networks.length} networks`);
    }

    // Populate currency dropdown with all available currencies
    function populateCurrencyDropdown(selectedCurrency = '') {
        const currencySelect = document.getElementById('client_payout_currency');
        if (!currencySelect) return;

        // Clear existing options except the first placeholder
        currencySelect.innerHTML = '<option value="">-- Select Currency --</option>';

        // Add all currencies with formatted display: "CODE - Name"
        currencyNetworkData.all_currencies.forEach(currency => {
            const option = document.createElement('option');
            option.value = currency;  // Value is just the code (e.g., "USDT")

            // Get friendly name from lookup table
            const currencyName = currencyNetworkData.currencies_with_names[currency] || currency;
            option.textContent = `${currency} - ${currencyName}`;  // Display: "USDT - Tether USDt"

            if (currency === selectedCurrency) {
                option.selected = true;
            }
            currencySelect.appendChild(option);
        });

        console.log(`üìä Populated currency dropdown with ${currencyNetworkData.all_currencies.length} currencies`);
    }

    // Filter currencies based on selected network
    function filterCurrenciesByNetwork(selectedNetwork) {
        const currencySelect = document.getElementById('client_payout_currency');
        if (!currencySelect || !selectedNetwork) {
            populateCurrencyDropdown();
            return;
        }

        // Get currencies available for this network (array of objects with currency and currency_name)
        const availableCurrencyObjects = currencyNetworkData.network_to_currencies[selectedNetwork] || [];

        // Store current selection
        const currentCurrency = currencySelect.value;

        // Clear and repopulate currency dropdown
        currencySelect.innerHTML = '<option value="">-- Select Currency --</option>';

        // Sort by currency code
        availableCurrencyObjects.sort((a, b) => a.currency.localeCompare(b.currency)).forEach(currencyObj => {
            const option = document.createElement('option');
            option.value = currencyObj.currency;  // Value is just the code (e.g., "USDT")
            option.textContent = `${currencyObj.currency} - ${currencyObj.currency_name}`;  // Display: "USDT - Tether USDt"
            currencySelect.appendChild(option);
        });

        // Restore selection if still valid
        const availableCurrencyCodes = availableCurrencyObjects.map(obj => obj.currency);
        if (availableCurrencyCodes.includes(currentCurrency)) {
            currencySelect.value = currentCurrency;
        } else {
            currencySelect.value = '';
        }

        console.log(`üîΩ Filtered to ${availableCurrencyObjects.length} currencies for network: ${selectedNetwork}`);
    }

    // Filter networks based on selected currency
    function filterNetworksByCurrency(selectedCurrency) {
        const networkSelect = document.getElementById('client_payout_network');
        if (!networkSelect || !selectedCurrency) {
            populateNetworkDropdown();
            return;
        }

        // Get networks available for this currency (array of objects with network and network_name)
        const availableNetworkObjects = currencyNetworkData.currency_to_networks[selectedCurrency] || [];

        // Store current selection
        const currentNetwork = networkSelect.value;

        // Clear and repopulate network dropdown
        networkSelect.innerHTML = '<option value="">-- Select Network --</option>';

        // Sort by network code
        availableNetworkObjects.sort((a, b) => a.network.localeCompare(b.network)).forEach(networkObj => {
            const option = document.createElement('option');
            option.value = networkObj.network;  // Value is just the code (e.g., "ETH")
            option.textContent = `${networkObj.network} - ${networkObj.network_name}`;  // Display: "ETH - Ethereum"
            networkSelect.appendChild(option);
        });

        // Restore selection if still valid
        const availableNetworkCodes = availableNetworkObjects.map(obj => obj.network);
        if (availableNetworkCodes.includes(currentNetwork)) {
            networkSelect.value = currentNetwork;
        } else {
            networkSelect.value = '';
        }

        console.log(`üîΩ Filtered to ${availableNetworkObjects.length} networks for currency: ${selectedCurrency}`);
    }

    // Event listener for network selection
    function onNetworkChange() {
        const networkSelect = document.getElementById('client_payout_network');
        const selectedNetwork = networkSelect.value;

        console.log(`üåê Network selected: ${selectedNetwork}`);

        if (selectedNetwork) {
            filterCurrenciesByNetwork(selectedNetwork);
        } else {
            populateCurrencyDropdown();
        }
    }

    // Event listener for currency selection
    function onCurrencyChange() {
        const currencySelect = document.getElementById('client_payout_currency');
        const selectedCurrency = currencySelect.value;

        console.log(`üí∞ Currency selected: ${selectedCurrency}`);

        if (selectedCurrency) {
            filterNetworksByCurrency(selectedCurrency);
        } else {
            populateNetworkDropdown();
        }
    }

    // Reset payment fields (Network Type & Payout Currency)
    function resetPaymentFields() {
        console.log('üîÑ Resetting payment fields...');

        const networkSelect = document.getElementById('client_payout_network');
        const currencySelect = document.getElementById('client_payout_currency');

        // Reset both dropdowns to empty selection
        if (networkSelect) {
            networkSelect.value = '';
            console.log('‚úÖ Network Type reset to default');
        }

        if (currencySelect) {
            currencySelect.value = '';
            console.log('‚úÖ Payout Currency reset to default');
        }

        // Repopulate both dropdowns with all available options (remove any filtering)
        populateNetworkDropdown();
        populateCurrencyDropdown();

        console.log('‚úÖ Payment fields reset complete - all options restored');
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ Initializing currency-network dynamic filtering...');

        // Fetch mappings and setup dropdowns
        fetchCurrencyNetworkMappings();

        // Attach event listeners
        const networkSelect = document.getElementById('client_payout_network');
        const currencySelect = document.getElementById('client_payout_currency');

        if (networkSelect) {
            networkSelect.addEventListener('change', onNetworkChange);
            console.log('‚úÖ Network dropdown event listener attached');
        }

        if (currencySelect) {
            currencySelect.addEventListener('change', onCurrencyChange);
            console.log('‚úÖ Currency dropdown event listener attached');
        }

        // Attach reset button event listener
        const resetBtn = document.getElementById('resetPaymentFieldsBtn');
        if (resetBtn) {
            resetBtn.addEventListener('click', resetPaymentFields);
            console.log('‚úÖ Reset button event listener attached');
        }

        // Form submission handler
        const form = document.querySelector('form');
        if (form) {
            form.addEventListener('submit', function(e) {
                const submitBtn = form.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Registering...';
                }
            });
        }

        console.log('‚úÖ Dynamic filtering initialized');
    });
</script>
{% endblock %}
