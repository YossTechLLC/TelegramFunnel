================================================================================
  GCHostPay10-21 DEPLOYMENT CHECKLIST
  Critical Steps to Deploy Host Wallet Payment Service
================================================================================

LATEST UPDATE (2025-10-22):
âœ… Dockerfile fixed (all modules copied)
âœ… Web3 checksum address fix deployed
âœ… Database ENUM + Precision fix READY (pending deployment)

CURRENT ISSUE TO DEPLOY:
- Database insert failing with ENUM error: currency_type expects "ETH" not "eth"
- Precision mismatch: NUMERIC(12,8) requires rounding from_amount to 8 decimals

STATUS: Code ready for deployment - see DATABASE_PRECISION_FIX.txt for details

================================================================================
  PRE-DEPLOYMENT CHECKLIST
================================================================================

â–¡ 0. VERIFY DATABASE FIX IS IN CODE (NEW - CRITICAL!)
   Check database_manager.py line 167:
   âœ… Must have: from_amount_rounded = round(float(from_amount), 8)

   Check database_manager.py line 179:
   âœ… Must have: from_currency.upper(), from_network.upper(), from_amount_rounded

   Check database_manager.py lines 181-189:
   âœ… Must have: Detailed parameter logging block

   This fixes the current production issue preventing database inserts!

â–¡ 1. VERIFY LOCAL CODE FILES EXIST
   Location: /OCTOBER/10-18/GCHostPay10-21/

   Required files:
   â˜‘ tphp10-21.py (main application)
   â˜‘ database_manager.py (PostgreSQL operations)
   â˜‘ wallet_manager.py (Web3 ETH transfers)
   â˜‘ alchemy_webhook_handler.py (transaction monitoring)
   â˜‘ requirements.txt (Python dependencies)
   â˜‘ Dockerfile (container configuration)
   â˜‘ .dockerignore (optional)

â–¡ 2. VERIFY DOCKERFILE COPIES ALL FILES
   Check Dockerfile lines 21-25 contain:

   COPY tphp10-21.py .
   COPY database_manager.py .
   COPY wallet_manager.py .
   COPY alchemy_webhook_handler.py .

   âš ï¸ CRITICAL: If any file is missing, imports will fail silently!

â–¡ 3. VERIFY REQUIREMENTS.TXT
   Check requirements.txt contains:

   Flask==3.0.3
   google-cloud-secret-manager==2.16.3
   requests==2.31.0
   web3==6.11.3
   pg8000==1.30.3
   cloud-sql-python-connector==1.4.3

   âš ï¸ NOTE: alchemy-sdk removed (not actually used in code)

â–¡ 4. VERIFY ALL SECRETS EXIST IN SECRET MANAGER
   Run these commands to verify:

   gcloud secrets describe TPS_HOSTPAY_SIGNING_KEY
   gcloud secrets describe HOST_WALLET_ETH_ADDRESS
   gcloud secrets describe HOST_WALLET_PRIVATE_KEY
   gcloud secrets describe ETHEREUM_RPC_URL
   gcloud secrets describe ETHEREUM_RPC_URL_API
   gcloud secrets describe ETHEREUM_RPC_WEBHOOK_SECRET
   gcloud secrets describe CHANGENOW_API_KEY
   gcloud secrets describe DATABASE_NAME_SECRET
   gcloud secrets describe DATABASE_USER_SECRET
   gcloud secrets describe DATABASE_PASSWORD_SECRET
   gcloud secrets describe CLOUD_SQL_CONNECTION_NAME

   Each should return: "name: projects/291176869049/secrets/[SECRET_NAME]"

   If any fail, create them first!

â–¡ 5. VERIFY SERVICE ACCOUNT PERMISSIONS
   Service account needs these roles:

   â˜‘ Secret Manager Secret Accessor
   â˜‘ Cloud SQL Client
   â˜‘ Cloud Run Developer

   Check with:
   gcloud projects get-iam-policy 291176869049 \
     --flatten="bindings[].members" \
     --filter="bindings.members:serviceAccount:*@*.iam.gserviceaccount.com"


================================================================================
  DEPLOYMENT COMMAND
================================================================================

Navigate to service directory:
cd /path/to/GCHostPay10-21

Deploy to Cloud Run:

gcloud run deploy tphp10-21 \
    --source . \
    --region us-central1 \
    --platform managed \
    --allow-unauthenticated \
    --memory 1Gi \
    --cpu 1 \
    --timeout 600 \
    --max-instances 10 \
    --min-instances 0 \
    --port 8080 \
    --set-env-vars TPS_HOSTPAY_SIGNING_KEY=projects/291176869049/secrets/TPS_HOSTPAY_SIGNING_KEY/versions/latest \
    --set-env-vars HOST_WALLET_ETH_ADDRESS=projects/291176869049/secrets/HOST_WALLET_ETH_ADDRESS/versions/latest \
    --set-env-vars HOST_WALLET_PRIVATE_KEY=projects/291176869049/secrets/HOST_WALLET_PRIVATE_KEY/versions/latest \
    --set-env-vars ETHEREUM_RPC_URL=projects/291176869049/secrets/ETHEREUM_RPC_URL/versions/latest \
    --set-env-vars ETHEREUM_RPC_URL_API=projects/291176869049/secrets/ETHEREUM_RPC_URL_API/versions/latest \
    --set-env-vars ETHEREUM_RPC_WEBHOOK_SECRET=projects/291176869049/secrets/ETHEREUM_RPC_WEBHOOK_SECRET/versions/latest \
    --set-env-vars CHANGENOW_API_KEY=projects/291176869049/secrets/CHANGENOW_API_KEY/versions/latest \
    --set-env-vars DATABASE_NAME_SECRET=projects/291176869049/secrets/DATABASE_NAME_SECRET/versions/latest \
    --set-env-vars DATABASE_USER_SECRET=projects/291176869049/secrets/DATABASE_USER_SECRET/versions/latest \
    --set-env-vars DATABASE_PASSWORD_SECRET=projects/291176869049/secrets/DATABASE_PASSWORD_SECRET/versions/latest \
    --set-env-vars CLOUD_SQL_CONNECTION_NAME=projects/291176869049/secrets/CLOUD_SQL_CONNECTION_NAME/versions/latest


================================================================================
  POST-DEPLOYMENT VERIFICATION
================================================================================

â–¡ 1. CHECK DEPLOYMENT SUCCEEDED
   Expected output:
   "Service [tphp10-21] revision [tphp10-21-XXXXX] has been deployed"

   Note the service URL:
   https://tphp10-21-291176869049.us-central1.run.app

â–¡ 2. TEST HEALTH ENDPOINT
   curl https://tphp10-21-291176869049.us-central1.run.app/health

   Expected response:
   {
     "status": "healthy",
     "service": "GCHostPay10-21 Host Wallet Payment Service",
     "timestamp": 1729567890,
     "configuration": {
       "signing_key": "âœ…"
     }
   }

â–¡ 3. CHECK CLOUD RUN LOGS - INITIALIZATION
   gcloud run services logs read tphp10-21 \
     --region us-central1 \
     --limit 50

   Expected logs:
   âœ… [INFO] Cloud SQL Connector imported successfully
   ðŸ”„ [WALLET] Initializing wallet credentials
   âœ… [WALLET] Wallet credentials initialized
   ðŸ¦ [WALLET] Host Wallet: 0x...
   ðŸŒ [WALLET] Provider URL: https://...

   âš ï¸ RED FLAGS (should NOT see):
   âŒ [ERROR] Cloud SQL Connector import failed
   âŒ [WALLET_CONFIG] Environment variable X is not set
   ModuleNotFoundError: No module named 'database_manager'
   ModuleNotFoundError: No module named 'wallet_manager'

â–¡ 4. TRIGGER TEST WEBHOOK (from TPS10-21)
   This will happen automatically on next payment.

   Expected logs in tphp10-21:
   ðŸŽ¯ [HOSTPAY_WEBHOOK] Webhook called
   ðŸ“¦ [HOSTPAY_WEBHOOK] Received token (length: X chars)
   ðŸ” [CONFIG] Fetching TPS HostPay signing key
   âœ… [CONFIG] Successfully fetched TPS HostPay signing key
   ðŸ”“ [TOKEN_VALIDATION] Token validated successfully
   âœ… [HOSTPAY_WEBHOOK] Token validated and decoded successfully
   ðŸ“¦ [HOSTPAY_WEBHOOK] Extracted values:
      ðŸ†” unique_id: XXXXXXXXXXXXXXXX
      ðŸ†” cn_api_id: xxxxxxxxxxxxxx
      ðŸ’° from_currency: eth
      ðŸŒ from_network: eth
      ðŸ’¸ from_amount: 0.XXXXXX
      ðŸ¦ payin_address: 0xXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
   ðŸ” [HOSTPAY_WEBHOOK] Checking if transaction already processed
   ðŸ” [HOSTPAY_WEBHOOK] Checking ChangeNow transaction status
   ðŸŒ [CHANGENOW_STATUS] Request URL: https://api.changenow.io/v2/exchange/by-id?id=...
   âœ… [CHANGENOW_STATUS] API response received
   ðŸ“Š [CHANGENOW_STATUS] Transaction status: waiting
   âœ… [HOSTPAY_WEBHOOK] ChangeNow status confirmed: waiting
   ðŸ’° [HOSTPAY_WEBHOOK] Initiating ETH payment
   ðŸ”— [WALLET] Connecting to Web3 provider
   âœ… [WALLET] Connected to Web3 provider
   ðŸ’° [ETH_PAYMENT] Initiating ETH payment for transaction: XXXXXXXXXXXXXXXX
   ðŸ”„ [TX_RETRY] Attempt 1/3
   â›½ [GAS] Fetching optimized gas prices using EIP-1559
   âœ… [GAS] EIP-1559 gas prices calculated
   ðŸ“ [TX_RETRY] Transaction built (EIP-1559)
   ðŸ” [TX_RETRY] Signing transaction
   ðŸ“¤ [TX_RETRY] Broadcasting transaction
   âœ… [TX_RETRY] Transaction broadcasted
   ðŸ†” [TX_RETRY] TX Hash: 0x...
   â³ [TX_RETRY] Waiting for confirmation (300s timeout)...
   ðŸŽ‰ [TX_RETRY] Transaction confirmed!
   âœ… [HOSTPAY_WEBHOOK] ETH payment successful
   ðŸ’¾ [HOSTPAY_WEBHOOK] Logging transaction to database
   ðŸ“ [HOSTPAY_DB] Starting database insert for unique_id: XXXXXXXXXXXXXXXX
   ðŸ”— [DATABASE] âœ… Cloud SQL Connector connection successful!
   ðŸ“‹ [HOSTPAY_DB] Insert parameters: (NEW - DETAILED LOGGING)
      unique_id: XXXXXXXXXXXXXXXX (len: 16)
      cn_api_id: xxxxxxxxxxxxxx (len: 14)
      from_currency: ETH (UPPERCASE - FIXED!)
      from_network: ETH (UPPERCASE - FIXED!)
      from_amount: 0.00055638 (original: 0.0005563751532725799) (ROUNDED - FIXED!)
      payin_address: 0x... (len: 42)
      is_complete: True
   ðŸ”„ [HOSTPAY_DB] Executing INSERT query
   âœ… [HOSTPAY_DB] Transaction committed successfully (MUST SEE - WAS FAILING BEFORE!)
   ðŸŽ‰ [HOSTPAY_DB] Successfully inserted record for unique_id: XXXXXXXXXXXXXXXX
   ðŸ”Œ [HOSTPAY_DB] Database connection closed
   ðŸŽ‰ [HOSTPAY_WEBHOOK] Host payment completed successfully!

   âš ï¸ RED FLAGS (should NOT see after fix):
   âŒ invalid input value for enum currency_type: "eth"
   ðŸ”„ [HOSTPAY_DB] Transaction rolled back due to error
   âŒ numeric field overflow
   âš ï¸ [HOSTPAY_WEBHOOK] Database logging failed (non-fatal)
   âš ï¸ [HOSTPAY_WEBHOOK] ETH transfer not yet implemented
   âŒ [WALLET] Missing required wallet credentials
   ModuleNotFoundError: No module named 'wallet_manager'


================================================================================
  TROUBLESHOOTING COMMON ISSUES
================================================================================

ISSUE: "ETH transfer not yet implemented" message appears
CAUSE: Dockerfile didn't copy wallet_manager.py and database_manager.py
FIX:   1. Verify Dockerfile lines 21-25 copy all 4 Python files
       2. Redeploy with fixed Dockerfile
       3. Check logs show successful module imports

ISSUE: ModuleNotFoundError: No module named 'database_manager'
CAUSE: Dockerfile didn't copy database_manager.py
FIX:   Add "COPY database_manager.py ." to Dockerfile, redeploy

ISSUE: ModuleNotFoundError: No module named 'wallet_manager'
CAUSE: Dockerfile didn't copy wallet_manager.py
FIX:   Add "COPY wallet_manager.py ." to Dockerfile, redeploy

ISSUE: ModuleNotFoundError: No module named 'alchemy_webhook_handler'
CAUSE: Dockerfile didn't copy alchemy_webhook_handler.py
FIX:   Add "COPY alchemy_webhook_handler.py ." to Dockerfile, redeploy

ISSUE: "âŒ [WALLET_CONFIG] Environment variable X is not set"
CAUSE: Missing --set-env-vars flag in deployment command
FIX:   Add missing environment variable to deployment command, redeploy

ISSUE: "âŒ [CONFIG] Error fetching secret from Secret Manager"
CAUSE: Secret doesn't exist or service account lacks permissions
FIX:   1. Verify secret exists: gcloud secrets describe [SECRET_NAME]
       2. Grant secretAccessor role to service account
       3. Redeploy

ISSUE: "âŒ [WALLET] Error connecting to Web3: HTTPError"
CAUSE: Invalid ETHEREUM_RPC_URL or API key
FIX:   1. Verify RPC URL is correct (Alchemy/Infura)
       2. Test URL manually: curl [RPC_URL]
       3. Update secret, redeploy

ISSUE: "âŒ [ETH_PAYMENT] Insufficient funds"
CAUSE: Host wallet doesn't have enough ETH
FIX:   Fund the host wallet with ETH for gas + payment amounts

ISSUE: Transaction gets stuck "â³ [TX_RETRY] Waiting for confirmation"
CAUSE: Network congestion or gas price too low
FIX:   Wait for timeout, system will retry with higher gas price

ISSUE: "âŒ [HOSTPAY_DB] Error inserting transaction"
CAUSE: Database credentials invalid or Cloud SQL unreachable
FIX:   1. Verify DATABASE_* secrets are correct
       2. Check Cloud SQL instance is running
       3. Verify service account has Cloud SQL Client role


================================================================================
  DATABASE TABLE VERIFICATION
================================================================================

After successful deployment, verify the split_payout_hostpay table exists:

Connect to database:
gcloud sql connect [INSTANCE_NAME] --user=[DB_USER] --database=[DB_NAME]

Check table structure:
\d split_payout_hostpay

Expected columns:
- unique_id (VARCHAR(16), PRIMARY KEY)
- cn_api_id (VARCHAR(255))
- from_currency (VARCHAR(10))
- from_network (VARCHAR(50))
- from_amount (NUMERIC(20,10))
- payin_address (VARCHAR(255))
- is_complete (BOOLEAN)
- created_at (TIMESTAMP)
- updated_at (TIMESTAMP)

If table doesn't exist, create it:
(See database_manager.py for schema or consult README.md)


================================================================================
  UPDATE GCSPLIT10-21 WITH NEW URL
================================================================================

After successful deployment, update GCSplit10-21 with the HostPay webhook URL:

1. Create/update HOSTPAY_WEBHOOK_URL secret:
   echo -n "https://tphp10-21-291176869049.us-central1.run.app" | \
     gcloud secrets versions add HOSTPAY_WEBHOOK_URL --data-file=-

2. Redeploy GCSplit10-21 to pick up new URL:
   (It should already have HOSTPAY_WEBHOOK_URL in env vars)


================================================================================
  SUCCESS CRITERIA
================================================================================

Deployment is successful when ALL of these are true:

âœ… Health endpoint returns {"status": "healthy"}
âœ… Logs show "âœ… [WALLET] Wallet credentials initialized"
âœ… Logs show "âœ… [INFO] Cloud SQL Connector imported successfully"
âœ… No ModuleNotFoundError in logs
âœ… Webhook receives token and processes it (not "not yet implemented")
âœ… ETH payment executes successfully
âœ… Transaction logged to split_payout_hostpay table
âœ… Logs show "ðŸŽ‰ [HOSTPAY_WEBHOOK] Host payment completed successfully!"


================================================================================
  ROLLBACK PROCEDURE
================================================================================

If deployment fails, rollback to previous revision:

1. List revisions:
   gcloud run revisions list --service tphp10-21 --region us-central1

2. Find last working revision (e.g., tphp10-21-00005-abc)

3. Rollback:
   gcloud run services update-traffic tphp10-21 \
     --region us-central1 \
     --to-revisions tphp10-21-00005-abc=100

4. Verify rollback:
   curl https://tphp10-21-291176869049.us-central1.run.app/health


================================================================================
  MONITORING & ALERTS
================================================================================

Set up monitoring for:

â–¡ Health check failures (>2 in 5 minutes)
â–¡ ETH payment failures (any)
â–¡ Database insert failures (>3 in 10 minutes)
â–¡ Gas price spikes (>100 Gwei)
â–¡ Wallet balance low (<0.1 ETH)

Use Cloud Monitoring:
gcloud monitoring dashboards create \
  --config-from-file=monitoring-dashboard.yaml


================================================================================
  END OF DEPLOYMENT CHECKLIST
================================================================================

Last Updated: 2025-10-22
Issue: Dockerfile missing supporting module files
Resolution: Added COPY commands for all required .py files
