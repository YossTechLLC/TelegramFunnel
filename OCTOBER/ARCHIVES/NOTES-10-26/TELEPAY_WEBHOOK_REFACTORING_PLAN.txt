================================================================================
TELEPAY10-26 WEBHOOK REFACTORING PLAN
Google Cloud Tasks Architecture Design
================================================================================

Date: 2025-10-26
Purpose: Refactor TelePay10-26 from monolithic long-polling bot to event-driven
         webhook-based microservices using Google Cloud Tasks architecture
Status: DESIGN PHASE - Ready for Implementation

================================================================================
EXECUTIVE SUMMARY
================================================================================

CURRENT ARCHITECTURE PROBLEMS:

âŒ Long-Polling Bot: Consumes resources 24/7, even when idle
âŒ Single Point of Failure: If bot crashes, all functionality stops
âŒ No Retry Logic: Failed operations (Telegram API, DB) fail permanently
âŒ Background Loops: Subscription monitoring runs every 60s regardless of load
âŒ No Rate Limiting: Broadcast operations can overwhelm Telegram API
âŒ Poor Scalability: Cannot scale horizontally (single bot instance)
âŒ Tight Coupling: All functionality in one service
âŒ No Queue Management: Operations execute synchronously

PROPOSED SOLUTION:

âœ… Webhook-Based Bot: Only runs when Telegram sends updates (event-driven)
âœ… Microservices: Independent services with single responsibilities
âœ… Infinite Retry: Cloud Tasks provides automatic retry (60s backoff, 24h max)
âœ… Scheduled Tasks: Cloud Scheduler triggers subscription checks
âœ… Rate-Limited: Cloud Tasks queues throttle Telegram API calls
âœ… Horizontal Scaling: Each service can scale independently
âœ… Loose Coupling: Services communicate via Cloud Tasks queues
âœ… Queue Management: Asynchronous, reliable task dispatch

BENEFITS:

ğŸš€ 99%+ Cost Reduction: Only pay for actual bot interactions (not 24/7 polling)
ğŸš€ Zero Downtime: Cloud Run auto-scales and auto-restarts
ğŸš€ Guaranteed Delivery: Cloud Tasks ensures operations complete (infinite retry)
ğŸš€ Better Performance: Event-driven is faster than polling
ğŸš€ Easier Monitoring: Cloud Logging + Cloud Monitoring built-in
ğŸš€ Production-Ready: Same architecture as GCSplit, GCWebhook, GCHostPay

================================================================================
CURRENT ARCHITECTURE ANALYSIS
================================================================================

TELEPAY10-26 STRUCTURE:
```
TelePay10-26/
â”œâ”€â”€ telepay10-26.py              # Main orchestrator (56 lines)
â”œâ”€â”€ app_initializer.py           # App setup and initialization
â”œâ”€â”€ bot_manager.py               # Bot handler setup (112 lines)
â”œâ”€â”€ subscription_manager.py      # Subscription expiration monitoring (220 lines)
â”œâ”€â”€ broadcast_manager.py         # Broadcast message posting (112 lines)
â”œâ”€â”€ start_np_gateway.py          # NOWPayments integration (200+ lines)
â”œâ”€â”€ secure_webhook.py            # Success URL token generation (100+ lines)
â”œâ”€â”€ input_handlers.py            # Bot command/input handlers
â”œâ”€â”€ menu_handlers.py             # Bot menu/callback handlers
â”œâ”€â”€ message_utils.py             # Message formatting utilities
â”œâ”€â”€ database.py                  # Database operations
â”œâ”€â”€ config_manager.py            # Configuration management
â””â”€â”€ server_manager.py            # Flask server (unused?)
```

CURRENT EXECUTION FLOW:

1. START: telepay10-26.py main()
2. INITIALIZE: AppInitializer sets up bot, db, handlers
3. FLASK THREAD: ServerManager starts Flask on random port (unused?)
4. BOT TASK: Long-polling bot runs indefinitely
5. SUBSCRIPTION TASK: Background loop checks expirations every 60s
6. WAIT: asyncio.gather() blocks until both tasks complete (never)

CURRENT COMPONENTS:

[COMPONENT 1] Telegram Bot (Long-Polling)
â”œâ”€â”€ Purpose: Handle user commands, buttons, messages
â”œâ”€â”€ Implementation: Application.run_polling()
â”œâ”€â”€ Runs: 24/7 continuously
â”œâ”€â”€ Handlers:
â”‚   â”œâ”€â”€ /start - Start bot, decode deep link tokens
â”‚   â”œâ”€â”€ /database - Enter channel configuration flow
â”‚   â”œâ”€â”€ /start_np_gateway_new - Trigger payment flow
â”‚   â”œâ”€â”€ /cancel - Cancel conversation
â”‚   â”œâ”€â”€ CallbackQueryHandler - Handle button clicks
â”‚   â”œâ”€â”€ ConversationHandler - Multi-step input flows
â”‚   â””â”€â”€ MessageHandler - Handle text messages
â””â”€â”€ Problem: Consumes resources even when idle, no retry logic

[COMPONENT 2] Subscription Manager (Background Task)
â”œâ”€â”€ Purpose: Check for expired subscriptions and remove users
â”œâ”€â”€ Implementation: asyncio loop with 60s sleep
â”œâ”€â”€ Runs: 24/7 continuously
â”œâ”€â”€ Process:
â”‚   1. Query database for expired subscriptions
â”‚   2. For each expired subscription:
â”‚      a. Call Telegram API to remove user from channel
â”‚      b. Update database to mark subscription as inactive
â”‚   3. Sleep 60 seconds
â”‚   4. Repeat
â””â”€â”€ Problem: Runs continuously even when no subscriptions expire, no retry

[COMPONENT 3] Broadcast Manager
â”œâ”€â”€ Purpose: Post welcome messages to open channels
â”œâ”€â”€ Implementation: Direct Telegram API POST requests
â”œâ”€â”€ Triggers: Manual via bot command (not documented)
â”œâ”€â”€ Process:
â”‚   1. Fetch all open channels from database
â”‚   2. For each channel:
â”‚      a. Build subscription tier buttons
â”‚      b. POST message to Telegram API
â”‚      c. Schedule message deletion after 60s
â””â”€â”€ Problem: No rate limiting, no retry, synchronous execution

[COMPONENT 4] Payment Gateway
â”œâ”€â”€ Purpose: Create NOWPayments invoices
â”œâ”€â”€ Implementation: Direct API calls to nowpayments.io
â”œâ”€â”€ Triggers: User clicks payment button or /start_np_gateway_new
â”œâ”€â”€ Process:
â”‚   1. Build signed success_url token
â”‚   2. Create invoice via NOWPayments API
â”‚   3. Send invoice URL to user
â””â”€â”€ Problem: No retry on API failure

[COMPONENT 5] Database Operations
â”œâ”€â”€ Purpose: CRUD operations for channels, subscriptions, users
â”œâ”€â”€ Implementation: Direct PostgreSQL queries via pg8000
â”œâ”€â”€ Triggers: Bot commands, payment flows, subscription checks
â”œâ”€â”€ Problem: Inline with bot, no connection pooling, no retry

[COMPONENT 6] Flask Server
â”œâ”€â”€ Purpose: Unknown (possibly webhook receiver?)
â”œâ”€â”€ Implementation: Empty Flask app on random port
â”œâ”€â”€ Runs: 24/7 in background thread
â”œâ”€â”€ Problem: Appears unused, wastes resources

STATUS: âŒ MONOLITHIC, RESOURCE-INTENSIVE, NO RETRY, NO SCALABILITY

================================================================================
PROPOSED WEBHOOK ARCHITECTURE
================================================================================

DESIGN PRINCIPLE: Follow the proven GCSplit/GCWebhook/GCHostPay pattern

MICROSERVICES TO CREATE:

1. TelePay-Bot-10-26 (Telegram Webhook Handler)
2. TelePay-Subscription-10-26 (Subscription Expiration Processor)
3. TelePay-Broadcast-10-26 (Channel Broadcast Sender)
4. TelePay-Payment-10-26 (Payment Gateway Coordinator)
5. TelePay-Database-10-26 (Database Service - Optional)

CLOUD TASKS QUEUES TO CREATE:

1. telepay-subscription-check-queue
2. telepay-subscription-removal-queue
3. telepay-broadcast-queue
4. telepay-payment-queue
5. telepay-database-queue (optional)

CLOUD SCHEDULER JOBS TO CREATE:

1. subscription-check-scheduler (every 5 minutes)
2. broadcast-scheduler (on-demand or daily)

ARCHITECTURE DIAGRAM:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        GOOGLE CLOUD PLATFORM                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Telegram API     â”‚         â”‚ Cloud Scheduler (Cron Jobs)          â”‚ â”‚
â”‚  â”‚ Webhook          â”‚         â”‚                                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚  â€¢ subscription-check (every 5min)   â”‚ â”‚
â”‚           â”‚ POST /webhook     â”‚  â€¢ broadcast-trigger (on-demand)     â”‚ â”‚
â”‚           â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚           â”‚                            â”‚ HTTP POST                      â”‚
â”‚           â–¼                            â–¼                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ TelePay-Bot-10-26 (Cloud Run)                                   â”‚  â”‚
â”‚  â”‚ â€¢ Receives Telegram webhooks                                    â”‚  â”‚
â”‚  â”‚ â€¢ Handles commands: /start, /database, etc.                     â”‚  â”‚
â”‚  â”‚ â€¢ Enqueues tasks to other services via Cloud Tasks             â”‚  â”‚
â”‚  â”‚ â€¢ Fast response (<100ms)                                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚              â”‚ Enqueue Tasks                                           â”‚
â”‚              â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Google Cloud Tasks (Queue Manager)                               â”‚ â”‚
â”‚  â”‚                                                                   â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚ telepay-subscription-check-queue                          â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ Dispatches to TelePay-Subscription-10-26               â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ Rate: 10 rps | Retry: 24h | Backoff: 60s              â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â”‚                                                                   â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚ telepay-subscription-removal-queue                        â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ Dispatches to TelePay-Subscription-10-26               â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ Rate: 5 rps (Telegram API limit) | Retry: 24h         â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â”‚                                                                   â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚ telepay-broadcast-queue                                   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ Dispatches to TelePay-Broadcast-10-26                  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ Rate: 8 rps (Telegram Bot API limit) | Retry: 24h     â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â”‚                                                                   â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚ telepay-payment-queue                                     â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ Dispatches to TelePay-Payment-10-26                    â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ Rate: 20 rps | Retry: 24h                              â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚              â”‚ Dispatch Tasks                                          â”‚
â”‚              â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Microservices (Cloud Run)                                         â”‚ â”‚
â”‚  â”‚                                                                    â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚  â”‚ TelePay-Subscription-10-26                                â”‚   â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ Check expired subscriptions                             â”‚   â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ Remove users from channels                              â”‚   â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ Update database (mark inactive)                         â”‚   â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â”‚                                                                    â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚  â”‚ TelePay-Broadcast-10-26                                   â”‚   â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ Post welcome messages to channels                       â”‚   â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ Schedule message deletion                               â”‚   â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â”‚                                                                    â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚  â”‚ TelePay-Payment-10-26                                     â”‚   â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ Create NOWPayments invoices                             â”‚   â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ Build signed success URLs                               â”‚   â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ PostgreSQL (Cloud SQL)                                          â”‚   â”‚
â”‚  â”‚ â€¢ public_channels_database                                      â”‚   â”‚
â”‚  â”‚ â€¢ private_channel_users_database                                â”‚   â”‚
â”‚  â”‚ â€¢ other tables...                                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

================================================================================
MICROSERVICE 1: TelePay-Bot-10-26 (Telegram Webhook Handler)
================================================================================

PURPOSE: Receive and process Telegram webhooks (replaces long-polling bot)

RESPONSIBILITIES:
â”œâ”€â”€ Receive POST requests from Telegram API webhook
â”œâ”€â”€ Process bot commands (/start, /database, /cancel, etc.)
â”œâ”€â”€ Handle callback queries (button clicks)
â”œâ”€â”€ Handle conversation states (multi-step flows)
â”œâ”€â”€ Enqueue tasks to other services via Cloud Tasks
â””â”€â”€ Return HTTP 200 quickly (<100ms response time)

ENDPOINTS:
â”œâ”€â”€ POST /webhook - Telegram webhook handler (main)
â”œâ”€â”€ GET /health - Health check endpoint
â””â”€â”€ POST /set_webhook - Setup Telegram webhook URL (admin)

WORKFLOW EXAMPLES:

[Example 1] User sends /start command
```
1. Telegram API â†’ POST /webhook {"message": {"text": "/start xyz..."}}
2. TelePay-Bot decodes deep link token (xyz)
3. TelePay-Bot determines action (subscription tier selection)
4. TelePay-Bot enqueues payment task to telepay-payment-queue
5. TelePay-Bot responds to user immediately
6. TelePay-Bot returns HTTP 200 to Telegram
7. Cloud Tasks dispatches to TelePay-Payment-10-26
8. TelePay-Payment creates NOWPayments invoice
9. TelePay-Payment sends invoice URL to user via Telegram API
```

[Example 2] User clicks payment button
```
1. Telegram API â†’ POST /webhook {"callback_query": {"data": "TRIGGER_PAYMENT"}}
2. TelePay-Bot answers callback query
3. TelePay-Bot enqueues payment task to telepay-payment-queue
4. TelePay-Bot returns HTTP 200 to Telegram
5. Cloud Tasks dispatches to TelePay-Payment-10-26
6. TelePay-Payment processes payment flow
```

[Example 3] User enters channel configuration
```
1. Telegram API â†’ POST /webhook {"message": {"text": "/database"}}
2. TelePay-Bot enters conversation state (OPEN_CHANNEL_INPUT)
3. TelePay-Bot sends prompt "Enter open channel ID"
4. TelePay-Bot returns HTTP 200 to Telegram
5. User enters channel ID
6. Telegram API â†’ POST /webhook {"message": {"text": "@mychannel"}}
7. TelePay-Bot validates input, moves to next state
8. TelePay-Bot sends next prompt
9. ... (continues for all config steps)
10. TelePay-Bot writes to database when flow completes
```

KEY FEATURES:
âœ… Stateless webhook handler (conversation state stored in context)
âœ… Fast response time (<100ms)
âœ… No long-polling (event-driven)
âœ… Automatic scaling via Cloud Run
âœ… Enqueues heavy operations to Cloud Tasks

DEPENDENCIES:
â”œâ”€â”€ python-telegram-bot (webhook mode, not polling)
â”œâ”€â”€ google-cloud-tasks (for task enqueue)
â”œâ”€â”€ google-cloud-secret-manager (for config)
â””â”€â”€ Flask (for webhook server)

ENVIRONMENT VARIABLES:
â”œâ”€â”€ TELEGRAM_BOT_SECRET_NAME (Secret Manager path)
â”œâ”€â”€ CLOUD_TASKS_PROJECT_ID
â”œâ”€â”€ CLOUD_TASKS_LOCATION
â”œâ”€â”€ TELEPAY_PAYMENT_QUEUE
â”œâ”€â”€ TELEPAY_BROADCAST_QUEUE
â”œâ”€â”€ TELEPAY_SUBSCRIPTION_QUEUE
â””â”€â”€ All service URLs (TELEPAY_PAYMENT_URL, etc.)

CLOUD TASKS INTEGRATION:

enqueue_payment_task():
  queue: telepay-payment-queue
  target: TelePay-Payment-10-26
  payload: {user_id, chat_id, subscription_tier, open_channel_id}

enqueue_broadcast_task():
  queue: telepay-broadcast-queue
  target: TelePay-Broadcast-10-26
  payload: {open_channel_id, message_config}

enqueue_database_task():
  queue: telepay-database-queue (optional)
  target: TelePay-Database-10-26
  payload: {operation, table, data}

MIGRATION FROM CURRENT:
â”œâ”€â”€ OLD: bot_manager.py + Application.run_polling()
â”œâ”€â”€ NEW: Webhook handler + Application.run_webhook()
â”œâ”€â”€ CHANGE: Remove asyncio.run() and background tasks
â”œâ”€â”€ CHANGE: Remove Flask ServerManager (use Cloud Run directly)
â””â”€â”€ BENEFIT: 99% cost reduction, auto-scaling, better performance

================================================================================
MICROSERVICE 2: TelePay-Subscription-10-26 (Subscription Processor)
================================================================================

PURPOSE: Check expired subscriptions and remove users from channels

RESPONSIBILITIES:
â”œâ”€â”€ Receive trigger from Cloud Scheduler (every 5 minutes)
â”œâ”€â”€ Query database for expired subscriptions
â”œâ”€â”€ For each expired subscription:
â”‚   â”œâ”€â”€ Enqueue removal task to telepay-subscription-removal-queue
â”‚   â””â”€â”€ Rate-limited via Cloud Tasks (5 rps)
â””â”€â”€ Return HTTP 200

ENDPOINTS:
â”œâ”€â”€ POST /check-expired - Triggered by Cloud Scheduler
â”œâ”€â”€ POST /remove-user - Triggered by Cloud Tasks (remove single user)
â””â”€â”€ GET /health - Health check endpoint

WORKFLOW:

[Scheduled Trigger] Every 5 minutes
```
1. Cloud Scheduler â†’ POST /check-expired
2. TelePay-Subscription queries database
3. SELECT * FROM private_channel_users_database
   WHERE is_active = true
   AND CONCAT(expire_date, ' ', expire_time) < NOW()
4. For each expired subscription:
   a. Enqueue to telepay-subscription-removal-queue
      payload: {user_id, private_channel_id}
5. Return HTTP 200 to Cloud Scheduler
6. Cloud Tasks dispatches removal tasks (rate-limited at 5 rps)
7. TelePay-Subscription â†’ POST /remove-user
8. Remove user from Telegram channel (ban + unban)
9. Update database: SET is_active = false
10. Return HTTP 200 (or 500 for retry)
```

KEY FEATURES:
âœ… Scheduled execution (every 5 min) instead of continuous loop
âœ… Rate-limited Telegram API calls (5 rps)
âœ… Infinite retry for failed removals (60s backoff, 24h max)
âœ… Separate check and removal for better parallelism
âœ… Scales horizontally during high load

QUEUE CONFIGURATION:

[Queue 1] telepay-subscription-check-queue
Purpose: Trigger subscription expiration checks
Rate: 10 dispatches/second (internal service, no limit)
Retry: Infinite for 24h (60s fixed backoff)

[Queue 2] telepay-subscription-removal-queue
Purpose: Remove individual users from channels
Rate: 5 dispatches/second (~50% of Telegram API limit)
Retry: Infinite for 24h (60s fixed backoff)
Rationale: Telegram ban_chat_member has ~10 rps limit per bot

CLOUD SCHEDULER CONFIGURATION:

Job: subscription-expiration-check
Schedule: */5 * * * * (every 5 minutes)
Target: TelePay-Subscription-10-26/check-expired
Method: POST
Retry: 3 attempts with exponential backoff

DEPENDENCIES:
â”œâ”€â”€ python-telegram-bot (for Telegram API calls)
â”œâ”€â”€ google-cloud-tasks (for task enqueue)
â”œâ”€â”€ google-cloud-secret-manager (for config)
â”œâ”€â”€ cloud-sql-python-connector (for database)
â””â”€â”€ Flask (for webhook server)

MIGRATION FROM CURRENT:
â”œâ”€â”€ OLD: subscription_manager.py with asyncio loop
â”œâ”€â”€ NEW: Webhook endpoint triggered by Cloud Scheduler
â”œâ”€â”€ CHANGE: Remove while True loop and sleep(60)
â”œâ”€â”€ CHANGE: Add Cloud Tasks queue for rate-limited removals
â””â”€â”€ BENEFIT: Only runs when needed, better rate limiting, retry capability

================================================================================
MICROSERVICE 3: TelePay-Broadcast-10-26 (Channel Broadcast Sender)
================================================================================

PURPOSE: Post welcome messages to open channels with subscription tier buttons

RESPONSIBILITIES:
â”œâ”€â”€ Receive trigger (manual or scheduled)
â”œâ”€â”€ Query database for all open channels
â”œâ”€â”€ For each channel:
â”‚   â”œâ”€â”€ Build subscription tier buttons
â”‚   â”œâ”€â”€ Post welcome message to channel
â”‚   â”œâ”€â”€ Schedule message deletion (after 60s)
â””â”€â”€ Return HTTP 200

ENDPOINTS:
â”œâ”€â”€ POST /broadcast-all - Broadcast to all channels
â”œâ”€â”€ POST /broadcast-one - Broadcast to specific channel
â”œâ”€â”€ GET /health - Health check endpoint

WORKFLOW:

[Manual Trigger] Admin calls broadcast
```
1. Admin â†’ POST /broadcast-all
2. TelePay-Broadcast queries database
3. SELECT * FROM public_channels_database
4. For each channel:
   a. Fetch subscription tiers (sub_1, sub_2, sub_3)
   b. Build inline keyboard buttons with deep link URLs
   c. Enqueue to telepay-broadcast-queue
      payload: {channel_id, message_text, buttons}
5. Return HTTP 200
6. Cloud Tasks dispatches broadcast tasks (rate-limited at 8 rps)
7. TelePay-Broadcast sends message to channel via Telegram API
8. TelePay-Broadcast schedules deletion task (60s delay)
9. Return HTTP 200 (or 500 for retry)
```

KEY FEATURES:
âœ… Rate-limited Telegram API calls (8 rps)
âœ… Infinite retry for failed broadcasts (60s backoff, 24h max)
âœ… Scheduled message deletion (Cloud Tasks delay)
âœ… Supports both batch and single-channel broadcasts

QUEUE CONFIGURATION:

[Queue] telepay-broadcast-queue
Purpose: Send broadcast messages to channels
Rate: 8 dispatches/second (~80% of Telegram Bot API limit)
Retry: Infinite for 24h (60s fixed backoff)
Rationale: Telegram sendMessage has ~30 rps limit, but we're conservative

DEPENDENCIES:
â”œâ”€â”€ python-telegram-bot (for Telegram API calls)
â”œâ”€â”€ google-cloud-tasks (for task enqueue + scheduled deletion)
â”œâ”€â”€ google-cloud-secret-manager (for config)
â”œâ”€â”€ cloud-sql-python-connector (for database)
â””â”€â”€ Flask (for webhook server)

MIGRATION FROM CURRENT:
â”œâ”€â”€ OLD: broadcast_manager.py with synchronous requests.post()
â”œâ”€â”€ NEW: Webhook endpoint with Cloud Tasks queue
â”œâ”€â”€ CHANGE: Replace direct API calls with queued tasks
â”œâ”€â”€ CHANGE: Add rate limiting via Cloud Tasks
â””â”€â”€ BENEFIT: No rate limit errors, retry capability, better reliability

================================================================================
MICROSERVICE 4: TelePay-Payment-10-26 (Payment Gateway Coordinator)
================================================================================

PURPOSE: Create NOWPayments invoices and manage payment flow

RESPONSIBILITIES:
â”œâ”€â”€ Receive payment request from TelePay-Bot via Cloud Tasks
â”œâ”€â”€ Build signed success_url token (same as current secure_webhook.py)
â”œâ”€â”€ Create NOWPayments invoice via API
â”œâ”€â”€ Send invoice URL to user via Telegram API
â””â”€â”€ Return HTTP 200

ENDPOINTS:
â”œâ”€â”€ POST / - Process payment request (from Cloud Tasks)
â”œâ”€â”€ GET /health - Health check endpoint

WORKFLOW:

[Payment Request] User clicks subscription tier
```
1. Cloud Tasks â†’ POST / (from telepay-payment-queue)
   payload: {user_id, chat_id, subscription_tier, open_channel_id}
2. TelePay-Payment fetches channel config from database
3. TelePay-Payment builds signed success_url token:
   - user_id (48-bit)
   - closed_channel_id (48-bit)
   - wallet_address
   - payout_currency
   - payout_network
   - subscription_time_days
   - subscription_price
   - HMAC-SHA256 signature (16-byte truncated)
4. TelePay-Payment calls NOWPayments API:
   POST https://api.nowpayments.io/v1/invoice
   {
     "price_amount": subscription_price,
     "price_currency": "USD",
     "order_id": "PGP-{user_id}{open_channel_id}",
     "success_url": "https://gcwebhook1-10-26-xxx.run.app/?token={token}",
     "is_fixed_rate": false,
     "is_fee_paid_by_user": false
   }
5. TelePay-Payment receives invoice_url from NOWPayments
6. TelePay-Payment sends invoice URL to user:
   Telegram API: sendMessage(chat_id, message_with_web_app_button)
7. TelePay-Payment returns HTTP 200 (or 500 for retry)
```

KEY FEATURES:
âœ… Infinite retry for NOWPayments API failures (60s backoff, 24h max)
âœ… Infinite retry for Telegram API failures (sending invoice URL)
âœ… Signed success_url prevents tampering
âœ… Integrates with existing GCWebhook1 flow

QUEUE CONFIGURATION:

[Queue] telepay-payment-queue
Purpose: Process payment gateway requests
Rate: 20 dispatches/second (NOWPayments API should handle this)
Retry: Infinite for 24h (60s fixed backoff)

DEPENDENCIES:
â”œâ”€â”€ python-telegram-bot (for Telegram API calls)
â”œâ”€â”€ httpx (for NOWPayments API calls)
â”œâ”€â”€ google-cloud-secret-manager (for config)
â”œâ”€â”€ cloud-sql-python-connector (for database)
â””â”€â”€ Flask (for webhook server)

MIGRATION FROM CURRENT:
â”œâ”€â”€ OLD: start_np_gateway.py inline with bot
â”œâ”€â”€ NEW: Separate webhook service
â”œâ”€â”€ CHANGE: Add retry capability via Cloud Tasks
â”œâ”€â”€ CHANGE: Remove inline execution from bot
â””â”€â”€ BENEFIT: Retry on failure, better reliability, scales independently

================================================================================
MICROSERVICE 5: TelePay-Database-10-26 (Database Service - OPTIONAL)
================================================================================

PURPOSE: Centralized database operations (optional abstraction layer)

NOTE: This is OPTIONAL. Can keep database operations inline in other services.
      Only create if you want strict separation of concerns.

RESPONSIBILITIES:
â”œâ”€â”€ Receive database operation requests via Cloud Tasks
â”œâ”€â”€ Execute CRUD operations on PostgreSQL
â”œâ”€â”€ Return results
â””â”€â”€ Provide connection pooling

ENDPOINTS:
â”œâ”€â”€ POST /query - Execute read query
â”œâ”€â”€ POST /execute - Execute write operation
â”œâ”€â”€ GET /health - Health check endpoint

MIGRATION FROM CURRENT:
â”œâ”€â”€ OLD: database.py with inline operations
â”œâ”€â”€ NEW: Separate database service (optional)
â”œâ”€â”€ DECISION: Recommend keeping database operations inline
â””â”€â”€ REASON: Adds latency, extra hops, not much benefit for this use case

STATUS: âŒ NOT RECOMMENDED - Keep database operations inline

================================================================================
CLOUD TASKS QUEUE CONFIGURATIONS
================================================================================

QUEUE 1: telepay-subscription-check-queue
```bash
gcloud tasks queues create telepay-subscription-check-queue \
  --location=us-central1 \
  --max-dispatches-per-second=10 \
  --max-concurrent-dispatches=15 \
  --max-attempts=-1 \
  --max-retry-duration=86400s \
  --min-backoff=60s \
  --max-backoff=60s \
  --max-doublings=0
```
Purpose: Trigger subscription expiration checks
Rate: 10 rps (internal service, no external API limits)
Concurrency: 15 (low, only runs every 5 minutes)

QUEUE 2: telepay-subscription-removal-queue
```bash
gcloud tasks queues create telepay-subscription-removal-queue \
  --location=us-central1 \
  --max-dispatches-per-second=5 \
  --max-concurrent-dispatches=15 \
  --max-attempts=-1 \
  --max-retry-duration=86400s \
  --min-backoff=60s \
  --max-backoff=60s \
  --max-doublings=0
```
Purpose: Remove users from Telegram channels
Rate: 5 rps (~50% of Telegram ban_chat_member limit of ~10 rps)
Concurrency: 15 (assumes ~3s p95 latency Ã— 5 rps)

QUEUE 3: telepay-broadcast-queue
```bash
gcloud tasks queues create telepay-broadcast-queue \
  --location=us-central1 \
  --max-dispatches-per-second=8 \
  --max-concurrent-dispatches=24 \
  --max-attempts=-1 \
  --max-retry-duration=86400s \
  --min-backoff=60s \
  --max-backoff=60s \
  --max-doublings=0
```
Purpose: Send broadcast messages to channels
Rate: 8 rps (~80% of Telegram sendMessage limit for safety)
Concurrency: 24 (assumes ~3s p95 latency Ã— 8 rps Ã— 1.5 safety)

QUEUE 4: telepay-payment-queue
```bash
gcloud tasks queues create telepay-payment-queue \
  --location=us-central1 \
  --max-dispatches-per-second=20 \
  --max-concurrent-dispatches=30 \
  --max-attempts=-1 \
  --max-retry-duration=86400s \
  --min-backoff=60s \
  --max-backoff=60s \
  --max-doublings=0
```
Purpose: Process payment gateway requests
Rate: 20 rps (NOWPayments API + Telegram API combined)
Concurrency: 30 (assumes ~1.5s p95 latency Ã— 20 rps)

================================================================================
CLOUD SCHEDULER CONFIGURATIONS
================================================================================

JOB 1: subscription-expiration-check
```bash
gcloud scheduler jobs create http subscription-expiration-check \
  --location=us-central1 \
  --schedule="*/5 * * * *" \
  --uri="https://telepay-subscription-10-26-xxx.run.app/check-expired" \
  --http-method=POST \
  --oidc-service-account-email=cloud-scheduler@telepay-459221.iam.gserviceaccount.com \
  --attempt-deadline=300s
```
Schedule: Every 5 minutes (*/5 * * * *)
Target: TelePay-Subscription-10-26/check-expired
Timeout: 5 minutes (300s)
Purpose: Trigger subscription expiration checks

JOB 2: broadcast-trigger (OPTIONAL)
```bash
gcloud scheduler jobs create http broadcast-trigger \
  --location=us-central1 \
  --schedule="0 0 * * *" \
  --uri="https://telepay-broadcast-10-26-xxx.run.app/broadcast-all" \
  --http-method=POST \
  --oidc-service-account-email=cloud-scheduler@telepay-459221.iam.gserviceaccount.com \
  --attempt-deadline=600s
```
Schedule: Daily at midnight (0 0 * * *)
Target: TelePay-Broadcast-10-26/broadcast-all
Timeout: 10 minutes (600s)
Purpose: Auto-broadcast to all channels (optional, can keep manual)

================================================================================
TELEGRAM WEBHOOK SETUP
================================================================================

CURRENT: Long-polling via Application.run_polling()
NEW: Webhook via Telegram setWebhook API

SETUP PROCESS:

1. Deploy TelePay-Bot-10-26 to Cloud Run
2. Get service URL: https://telepay-bot-10-26-xxx.run.app
3. Set Telegram webhook:
   ```bash
   curl -X POST \
     "https://api.telegram.org/bot<BOT_TOKEN>/setWebhook" \
     -H "Content-Type: application/json" \
     -d '{
       "url": "https://telepay-bot-10-26-xxx.run.app/webhook",
       "max_connections": 100,
       "allowed_updates": ["message", "callback_query"]
     }'
   ```
4. Verify webhook:
   ```bash
   curl "https://api.telegram.org/bot<BOT_TOKEN>/getWebhookInfo"
   ```

WEBHOOK ENDPOINT:

POST /webhook
â”œâ”€â”€ Receives: Telegram Update objects
â”œâ”€â”€ Processes: Commands, messages, callback queries
â”œâ”€â”€ Returns: HTTP 200 immediately (<100ms)
â””â”€â”€ Enqueues: Heavy operations to Cloud Tasks

BENEFITS vs LONG-POLLING:
âœ… 99% cost reduction (only pay for actual bot usage)
âœ… Faster response time (webhook is instant, polling has delay)
âœ… Auto-scaling via Cloud Run (handles burst traffic)
âœ… No connection drops (polling can lose connection)
âœ… Lower server load (no continuous polling)

================================================================================
MIGRATION CHECKLIST
================================================================================

PHASE 1: Preparation (No Code Changes)
â”œâ”€â”€ [ ] Review current TelePay10-26 functionality
â”œâ”€â”€ [ ] Identify all bot commands and handlers
â”œâ”€â”€ [ ] Identify all background tasks (subscription monitoring, broadcasts)
â”œâ”€â”€ [ ] Document all database operations
â”œâ”€â”€ [ ] Document all external API calls (Telegram, NOWPayments)
â””â”€â”€ [ ] Create migration timeline

PHASE 2: Infrastructure Setup
â”œâ”€â”€ [ ] Create Google Cloud Tasks queues (4 queues)
â”œâ”€â”€ [ ] Create Cloud Scheduler jobs (1-2 jobs)
â”œâ”€â”€ [ ] Set up Secret Manager secrets
â”œâ”€â”€ [ ] Set up Cloud SQL database (already exists)
â””â”€â”€ [ ] Set up Cloud Run service accounts and IAM permissions

PHASE 3: TelePay-Bot-10-26 Implementation
â”œâ”€â”€ [ ] Create project structure
â”œâ”€â”€ [ ] Implement config_manager.py
â”œâ”€â”€ [ ] Implement token_manager.py (for Cloud Tasks payloads)
â”œâ”€â”€ [ ] Implement cloudtasks_client.py
â”œâ”€â”€ [ ] Implement main webhook handler (telepay-bot-10-26.py)
â”œâ”€â”€ [ ] Migrate bot command handlers from input_handlers.py
â”œâ”€â”€ [ ] Migrate bot menu handlers from menu_handlers.py
â”œâ”€â”€ [ ] Create Dockerfile
â”œâ”€â”€ [ ] Create requirements.txt
â”œâ”€â”€ [ ] Test locally with ngrok webhook
â””â”€â”€ [ ] Deploy to Cloud Run

PHASE 4: TelePay-Subscription-10-26 Implementation
â”œâ”€â”€ [ ] Create project structure
â”œâ”€â”€ [ ] Implement config_manager.py
â”œâ”€â”€ [ ] Implement database_manager.py
â”œâ”€â”€ [ ] Implement main service (telepay-subscription-10-26.py)
â”œâ”€â”€ [ ] Migrate subscription check logic from subscription_manager.py
â”œâ”€â”€ [ ] Migrate user removal logic from subscription_manager.py
â”œâ”€â”€ [ ] Create Dockerfile
â”œâ”€â”€ [ ] Create requirements.txt
â”œâ”€â”€ [ ] Test locally
â”œâ”€â”€ [ ] Deploy to Cloud Run
â””â”€â”€ [ ] Configure Cloud Scheduler job

PHASE 5: TelePay-Broadcast-10-26 Implementation
â”œâ”€â”€ [ ] Create project structure
â”œâ”€â”€ [ ] Implement config_manager.py
â”œâ”€â”€ [ ] Implement database_manager.py
â”œâ”€â”€ [ ] Implement main service (telepay-broadcast-10-26.py)
â”œâ”€â”€ [ ] Migrate broadcast logic from broadcast_manager.py
â”œâ”€â”€ [ ] Create Dockerfile
â”œâ”€â”€ [ ] Create requirements.txt
â”œâ”€â”€ [ ] Test locally
â””â”€â”€ [ ] Deploy to Cloud Run

PHASE 6: TelePay-Payment-10-26 Implementation
â”œâ”€â”€ [ ] Create project structure
â”œâ”€â”€ [ ] Implement config_manager.py
â”œâ”€â”€ [ ] Implement secure_webhook.py (token generation)
â”œâ”€â”€ [ ] Implement main service (telepay-payment-10-26.py)
â”œâ”€â”€ [ ] Migrate payment gateway logic from start_np_gateway.py
â”œâ”€â”€ [ ] Create Dockerfile
â”œâ”€â”€ [ ] Create requirements.txt
â”œâ”€â”€ [ ] Test locally
â””â”€â”€ [ ] Deploy to Cloud Run

PHASE 7: Integration Testing
â”œâ”€â”€ [ ] Test bot webhook receives Telegram updates
â”œâ”€â”€ [ ] Test /start command with deep link token
â”œâ”€â”€ [ ] Test payment flow end-to-end
â”œâ”€â”€ [ ] Test subscription expiration check
â”œâ”€â”€ [ ] Test user removal from channels
â”œâ”€â”€ [ ] Test broadcast messages
â”œâ”€â”€ [ ] Test retry behavior (simulate failures)
â”œâ”€â”€ [ ] Test rate limiting (burst traffic)
â””â”€â”€ [ ] Load test with multiple concurrent users

PHASE 8: Telegram Webhook Setup
â”œâ”€â”€ [ ] Get TelePay-Bot-10-26 Cloud Run URL
â”œâ”€â”€ [ ] Call setWebhook API
â”œâ”€â”€ [ ] Verify webhook with getWebhookInfo
â”œâ”€â”€ [ ] Test with real Telegram bot
â””â”€â”€ [ ] Monitor logs for any issues

PHASE 9: Monitoring & Alerting
â”œâ”€â”€ [ ] Set up Cloud Monitoring dashboards
â”œâ”€â”€ [ ] Configure alerts for high error rates
â”œâ”€â”€ [ ] Configure alerts for queue depth
â”œâ”€â”€ [ ] Configure alerts for task age
â”œâ”€â”€ [ ] Set up log-based metrics
â””â”€â”€ [ ] Test alerting

PHASE 10: Cutover & Cleanup
â”œâ”€â”€ [ ] Stop old TelePay10-26 service (long-polling bot)
â”œâ”€â”€ [ ] Monitor new services for 7 days
â”œâ”€â”€ [ ] Archive old TelePay10-26 code
â”œâ”€â”€ [ ] Update documentation
â””â”€â”€ [ ] Celebrate! ğŸ‰

================================================================================
COST ANALYSIS
================================================================================

CURRENT COSTS (TelePay10-26 Long-Polling):

Cloud Run (24/7 bot running):
â”œâ”€â”€ 1 instance Ã— 24 hours Ã— 30 days = 720 instance-hours/month
â”œâ”€â”€ 512 MB RAM Ã— 720 hours = 368 GB-hours/month
â”œâ”€â”€ Cost: ~$18-25/month (always-on)
â””â”€â”€ Wasted: 99% idle time (bot just waits for updates)

NEW COSTS (Webhook-Based):

TelePay-Bot-10-26:
â”œâ”€â”€ Requests: ~1000 bot interactions/day = 30,000/month
â”œâ”€â”€ Avg execution: 100ms Ã— 30,000 = 3,000 seconds = 0.83 hours
â”œâ”€â”€ Cost: ~$0.05-0.10/month
â””â”€â”€ Savings: 99% reduction

TelePay-Subscription-10-26:
â”œâ”€â”€ Scheduled: Every 5 minutes = 8,640 triggers/month
â”œâ”€â”€ Avg execution: 5s Ã— 8,640 = 43,200 seconds = 12 hours
â”œâ”€â”€ Cost: ~$0.60/month
â””â”€â”€ Note: Only pays for actual processing time

TelePay-Broadcast-10-26:
â”œâ”€â”€ Usage: ~100 broadcasts/month (manual trigger)
â”œâ”€â”€ Avg execution: 10s Ã— 100 = 1,000 seconds = 0.28 hours
â”œâ”€â”€ Cost: ~$0.02/month
â””â”€â”€ Note: Negligible cost

TelePay-Payment-10-26:
â”œâ”€â”€ Requests: ~500 payments/month
â”œâ”€â”€ Avg execution: 2s Ã— 500 = 1,000 seconds = 0.28 hours
â”œâ”€â”€ Cost: ~$0.02/month
â””â”€â”€ Note: Negligible cost

Cloud Tasks:
â”œâ”€â”€ Queued tasks: ~40,000/month
â”œâ”€â”€ Cost: Free tier covers 1M tasks/month
â””â”€â”€ Cost: $0/month

Cloud Scheduler:
â”œâ”€â”€ Jobs: 2 jobs
â”œâ”€â”€ Cost: $0.10/job/month = $0.20/month
â””â”€â”€ Note: Minimal cost

TOTAL NEW COST: ~$0.80-1.00/month
TOTAL OLD COST: ~$18-25/month
SAVINGS: ~$17-24/month (95-98% reduction)

BENEFITS BEYOND COST:
âœ… Auto-scaling (handles burst traffic)
âœ… Zero downtime (Cloud Run auto-restarts)
âœ… Infinite retry (guaranteed delivery)
âœ… Better monitoring (Cloud Logging + Monitoring)
âœ… Independent scaling (each service scales independently)

================================================================================
RISK ANALYSIS & MITIGATION
================================================================================

RISK 1: Telegram Webhook Failures
â”œâ”€â”€ Impact: Bot stops receiving updates
â”œâ”€â”€ Probability: Low (Cloud Run 99.95% SLA)
â”œâ”€â”€ Mitigation:
â”‚   â”œâ”€â”€ Health check endpoint for monitoring
â”‚   â”œâ”€â”€ Alerting on webhook delivery failures
â”‚   â””â”€â”€ Fallback to long-polling if webhook fails (manual)
â””â”€â”€ Recovery: Redeploy service, re-set webhook

RISK 2: Cloud Tasks Queue Backlog
â”œâ”€â”€ Impact: Delayed processing (subscriptions, broadcasts)
â”œâ”€â”€ Probability: Low (queues designed for burst traffic)
â”œâ”€â”€ Mitigation:
â”‚   â”œâ”€â”€ Monitor queue depth metrics
â”‚   â”œâ”€â”€ Alert on queue depth > 1000 tasks
â”‚   â””â”€â”€ Increase rate limits if needed
â””â”€â”€ Recovery: Scale up service replicas

RISK 3: Database Connection Exhaustion
â”œâ”€â”€ Impact: Service errors, failed operations
â”œâ”€â”€ Probability: Medium (if many concurrent requests)
â”œâ”€â”€ Mitigation:
â”‚   â”œâ”€â”€ Use connection pooling (Cloud SQL Connector)
â”‚   â”œâ”€â”€ Limit max concurrent dispatches per queue
â”‚   â””â”€â”€ Monitor connection count
â””â”€â”€ Recovery: Increase Cloud SQL connection limit

RISK 4: Telegram API Rate Limiting
â”œâ”€â”€ Impact: Failed API calls (messages, removals)
â”œâ”€â”€ Probability: Low (queues throttle at safe rates)
â”œâ”€â”€ Mitigation:
â”‚   â”œâ”€â”€ Set conservative rate limits (5-8 rps)
â”‚   â”œâ”€â”€ Cloud Tasks retries automatically
â”‚   â””â”€â”€ Monitor Telegram API error rates
â””â”€â”€ Recovery: Reduce queue dispatch rate

RISK 5: NOWPayments API Downtime
â”œâ”€â”€ Impact: Unable to create payment invoices
â”œâ”€â”€ Probability: Medium (external dependency)
â”œâ”€â”€ Mitigation:
â”‚   â”œâ”€â”€ Cloud Tasks infinite retry (60s backoff, 24h max)
â”‚   â”œâ”€â”€ Monitor NOWPayments API success rate
â”‚   â””â”€â”€ Alert user if invoice creation delayed
â””â”€â”€ Recovery: Automatic retry when API recovers

RISK 6: Migration Bugs
â”œâ”€â”€ Impact: Broken functionality, user complaints
â”œâ”€â”€ Probability: Medium (major refactor)
â”œâ”€â”€ Mitigation:
â”‚   â”œâ”€â”€ Thorough testing before cutover
â”‚   â”œâ”€â”€ Phased rollout (test with small user group first)
â”‚   â”œâ”€â”€ Keep old system running for 7-day grace period
â”‚   â””â”€â”€ Rollback plan ready
â””â”€â”€ Recovery: Rollback to old TelePay10-26, fix bugs, redeploy

STATUS: âœ… RISKS ACCEPTABLE WITH MITIGATION STRATEGIES

================================================================================
SUCCESS CRITERIA
================================================================================

FUNCTIONAL REQUIREMENTS:
âœ… Bot responds to all commands (/start, /database, etc.)
âœ… Payment flow works end-to-end (invoice â†’ payment â†’ invite)
âœ… Subscription expiration monitoring works (users removed on expiration)
âœ… Broadcast messages sent successfully
âœ… No data loss during migration
âœ… All existing features preserved

PERFORMANCE REQUIREMENTS:
âœ… Bot webhook response time < 100ms (current: ~500ms)
âœ… Subscription check completes within 5 minutes
âœ… Payment invoice created within 3 seconds
âœ… Broadcast to 100 channels completes within 2 minutes

RELIABILITY REQUIREMENTS:
âœ… 99.9% uptime for bot webhook
âœ… Zero failed subscription removals (retry until success)
âœ… Zero failed payment invoices (retry until success)
âœ… Zero failed broadcasts (retry until success)

SCALABILITY REQUIREMENTS:
âœ… Handle 10x user growth without code changes
âœ… Auto-scale to handle burst traffic (100 concurrent users)
âœ… Independent scaling per service

COST REQUIREMENTS:
âœ… Reduce monthly cost by 95%+ (from $18-25 to $1-2)

MONITORING REQUIREMENTS:
âœ… Real-time dashboards for all services
âœ… Alerts for errors, queue backlogs, API failures
âœ… Log retention for 30 days

================================================================================
RECOMMENDATION
================================================================================

STATUS: âœ… HIGHLY RECOMMENDED - Proceed with Implementation

REASONING:

1. âœ… PROVEN ARCHITECTURE: Same pattern as GCSplit, GCWebhook, GCHostPay
   - Already tested and working in production
   - No unknowns or risky new technologies

2. âœ… MASSIVE COST SAVINGS: 95-98% reduction in Cloud Run costs
   - Current: $18-25/month (always-on bot)
   - New: $1-2/month (event-driven)

3. âœ… BETTER RELIABILITY: Infinite retry with Cloud Tasks
   - Current: Operations fail permanently
   - New: Retry every 60s for 24h

4. âœ… BETTER PERFORMANCE: Webhook is faster than polling
   - Current: ~500ms bot response time
   - New: <100ms bot response time

5. âœ… BETTER SCALABILITY: Auto-scaling + independent services
   - Current: Single bot instance, no scaling
   - New: Each service scales independently

6. âœ… PRODUCTION-READY: Cloud Run + Cloud Tasks are enterprise-grade
   - 99.95% SLA
   - Automatic failover
   - Built-in monitoring

7. âœ… EASIER MAINTENANCE: Smaller, focused services
   - Current: 2000+ lines monolithic bot
   - New: 4 services, each <500 lines

NEXT STEPS:

1. Review and approve this architecture plan
2. Begin Phase 1: Preparation (create checklist, timeline)
3. Begin Phase 2: Infrastructure setup (queues, scheduler)
4. Begin Phase 3-6: Service implementation (parallel development)
5. Begin Phase 7-10: Testing, deployment, cutover

ESTIMATED TIMELINE: 2-3 weeks for full implementation

================================================================================
END OF REFACTORING PLAN
================================================================================

Document Created: 2025-10-26
Status: READY FOR IMPLEMENTATION
Recommendation: APPROVED - Proceed with Migration

================================================================================
